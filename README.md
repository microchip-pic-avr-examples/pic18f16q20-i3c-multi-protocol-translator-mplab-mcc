[![MCHP](images/microchip.png)](https://www.microchip.com)

# I3C Multi-Protocol Translator Using the PIC18F16Q20 Microcontroller

## Introduction
This example showcases how the Improved Inter-Integrated Circuit® (I3C) Target peripheral of the PIC18F16Q20 family serves as a bridge device between the I3C Controller and other devices such as: Inter-Integrated Circuit (I2C), Serial Peripheral Interface (SPI) or Universal Asynchronous Receiver Transmitter (UART). Many industries are transitioning from traditional I2C/SPI/UART communication interfaces to a simple, faster, low-power managed I3C protocol. When sensor devices communicating over multiple interfaces co-exist on the same bus, it calls for a multi-protocol translator device which connects the I2C/SPI/UART devices to an I3C bus. The application example demonstrates the implementation of a I3C multi-protocol translator using PIC1F16Q20 and various client devices.

## Related Documentation
- [PIC18F16Q20 Product Page](https://www.microchip.com/product/PIC18F16Q20)
- [PIC18F16Q20 Data Sheet](https://www.microchip.com/DS40002387)
- [Data Sheet SHT3x-DIS](https://download.mikroe.com/documents/datasheets/SHT31-DIS_datasheet.pdf)
- [How to use Alert Mode of SHT3x-DIS](https://sensirion.com/media/documents/40D749F7/616400BB/Sensirion_Humidity_Sensors_SHT3x_Application_Note_Alert_Mode_DIS.pdf)

## Overview of Multi-Protocol Translator

The multi-protocol translator is implemented using the PIC18F16Q20 microcontroller having I3C Target, I2C, SPI and UART peripherals. The PIC MCU isolates the I2C/SPI/UART devices from a pure I3C bus. This maintains the integrity of the I3C bus, while still allowing the I3C Controller to communicate to the I2C/SPI/UART devices through the PIC18F16Q20 microcontroller. The PIC18F16Q20 acts as an interface between the pure I3C bus and the I2C/SPI/UART bus. Therefore, the MCU is configured as I3C Target, I2C Host and SPI Host.

In this example, the I3C-I2C/SPI/UART protocol translator demonstrates the following functionalities:
1.	The I3C Controller can write to the I2C, SPI and UART devices.
2.	The I3C Controller can read from the I2C, SPI and UART devices.
3.	Interrupts generated by the I2C/SPI devices using external signals relayed to the I3C Controller.
4.	The I3C Controller can reset the client devices connected to the I2C or the SPI bus.

The below section demonstrates an application of multi-protocol translator using PIC18F16Q20. PIC18F16Q20 acts as a pure protocol translator transferring data between I3C Controller and the I2C/SPI/UART devices. It does not process any data received. Therefore, any generic sensors connected over I2C/SPI/UART interfaces can be used to develop  applications using this firmware. The features of multi-protocol translator may be enhanced based on the application requirement.

## Software Used
- [MPLAB® X IDE v6.20](https://www.microchip.com/mplab/mplab-x-ide) or newer
- [XC8 Compiler 2.46](https://www.microchip.com/mplab/compilers) or newer
- [MPLAB® Code Configurator (MCC) 5.5.0](https://www.microchip.com/mplab/mplab-code-configurator) or newer
- [Microchip PIC18F-Q Series Device Support 1.25.433](https://packs.download.microchip.com/) or newer

## Hardware Used
- [PIC18F16Q20 Curiosity Nano Board](https://www.microchip.com/en-us/development-tool/EV73T25A)
- [Curiosity Nano base board](https://www.microchip.com/development-tool/AC164162)
- [SHT Click](https://www.mikroe.com/sht-click)
- [OLED B Click](https://www.mikroe.com/oled-b-click)
- [UART USB Click](https://www.mikroe.com/usb-uart-click)
- Any I3C Controller
- Logic Analyzer

## Implementation of Application Example

In this example, the I3C Controller communicates to a SHT Click interfaced over I2C bus, OLED B display interfaced over SPI and the virtual serial port (CDC) of the PIC18F16Q20 Curiosity Nano on-board debugger connected to UART channel. Additionally, a USB UART Click is used to print the debug messages. The SHT click contains a SHT3x-DIS sensor which is used for measuring relative humidity and temperature. OLED B is used to display messages. The CDC interface transmits to or receives data from the I3C Controller through the UART channel of PIC18F16Q20.

![Application example](images/block_diagram_example.png)

The I3C Controller must set up the I3C bus with the desired frequency. After power-up, the I3C Target makes a hot join request. It waits until the dynamic address is assigned by the Controller. Once the dynamic address is assigned, it is ready to receive commands from the Controller.

The I3C Controller will initiate a Read, Write, or Reset for the I2C/SPI client devices and Read/Write to UART devices by sending certain commands to the I3C Target through a Private Write transaction. In a Private Write transaction, the first byte of payload is a Function ID. The Function ID consists of the client ID of I2C/SPI clients, device ID for UART devices and the commands.

![FunctionID](images/functionID.png)

|Bit| Description |
|:------------------|:-----------------|
| b7: Res| Reserved |
| b6:5: Command [1:0] |<br>00-Reserved<br>01-Read<br>10-Write<br>11-Client Reset<br> |
| b4:3 Device ID [1:0]| <br>01 - UART1 <br> 10 - UART2|
| b2:0 Client ID [2:0] |<br>000– I2C device (The address of the I2C device must follow in the next byte)<br><br>001 ,010….111 – Identifier for each SPI device.<br>b0 = 1, CS1 is selected <br> b1 = 1, CS2 is selected<br> b2 = 1, CS3 is selected|

PIC18F16Q20 decodes the Function ID to decide what actions to perform.

**Note**:
The I3C Controller must be aware of the I2C client address, the CS pin corresponding to SPI client, I2C/SPI client devices connected to reset and interrupt pins, the UART TX pins and the Stop byte data for UART receive operation.

## Pin Connection Table

**Note:** The SCL and SDA pins of I3C (I3C2) are powered by VDDIO3 pins. In the current firmware, Configuration Byte 7 is configured such that VDDIO3 is in the low-voltage operating range of 0.95V-1.62V.

|Microcontroller Pin| Name | Description |
|:------------------:|:-----------------:|:------:|
| RB6| I3C2SCL | I3C bus serial clock input |
| RB5| I32SDA | I3C bus serial data input/output |
| RC4| TX1| UART1 transmit output pin|
| RC5| RX1| UART1 receive input pin|
| RA1| TX2| UART2 transmit output pin <sup>1</sup>|
| RA5 | SCK1| SPI serial clock output|
| RC3 | SDO1| SPI serial data out|
| RC6 | SDI1|SPI serial data in|
| RA4| CS1| SPI client select 1 output (Active low)|
| RC7 | CS2|SPI client select 2 output (Active low)|
| RB7 | CS3|SPI client select 3 output (Active low)|
| RC0 | SCL1|I2C bus serial clock output |
| RC1 | SDA1|I2C bus serial data input/output |
| RA2 | INT_pin1|Interrupt pin 1 (Active high input). Interrupt occurs when there is a positive edge. |
| RA0 |RST_pin1| Reset pin 1 (Active low output). Resets the client device by setting pin low. |

**Note:**
1. UART2 Tx pin is also used for printing debugging messages. Connect a UART-USB converter to print the messages. Note that the receive functionality is disabled for UART2.

## Setup

![Hardware Setup](images/hardware_setup.jpg)

In this example, the Curiosity Nano Base Board connects the click boards to the PIC18F16Q20 Curiosity Nano board. The OLED B Click board™ is placed in click slot one, USB UART Click is placed in click slot two and the SHT Click board™ is placed in click slot three. The on-board debugger present on Curiosity Nano board has a virtual serial port which is internally connected to UART on the PIC18F16Q20. Refer to the [Curiosity Nano board user guide](https://www.microchip.com/DS50003388) for more details on how the virtual serial ports works.

Connect pin RB6 to SCL pin of I3C Controller and connect pin RB5 to SDA pin of I3C Controller. As OLED B Click does not have a INT pin, interrupt pin 1 (INT1) is used to connect interrupt from SHT Click.

**Note:**
1. VDDIO3 pin of PIC18F16Q20 Curiosity Nano supplies power to I3C2 pins, which is by default at 1.2V. Therefore I3C bus operates at 1.2V. To operate I3C pins at a different voltage,  connect an external power supply to the J208 PIC18F16Q20 Curiosity Nano board. Remove R200 before connecting the external power supply to VDDIO3. The SPI and I2C bus operates at 3.3V.  
2. Connection from PIC18F16Q20 Curiosity Nano to the click slot is not available for RA1, RA2 pin. Jumper cable is used to make the required connection. Thus, short pin RA1 to TX2 on Curiosity Nano Base Board and short pin RA2 to INT3 on Curiosity Nano Base Board.

## Demo Operation

After the I3C bus initialization, the I3C Target generates a Hot-join request to an I3C bus and gets a dynamic address assigned. The section below explains in detail the commands from the Controller, how to communicate with the SHT Click, the OLED B display and the on-board debugger virtual serial port.

### SHT Click

To capture temperature and humidity values from SHT3x-DIS sensor, the I3C Controller must send a measurement command first. With the acknowledgement of the measurement command, the sensor starts measuring humidity and temperature. Refer to [Data Sheet of SHT3x-DIS](https://download.mikroe.com/documents/datasheets/SHT31-DIS_datasheet.pdf) for more details on the commands.

The measurement command triggers the acquisition of data pair. Each data pair consists of one 16 bit temperature and one 16 bit humidity value (in this order). After the sensor has completed the measurement, the Controller can send a command to readout measurement results. The sensor will send two bytes of data (temperature, MSB first and then LSB) followed by one byte CRC checksum and another two bytes of data (relative humidity, MSB first and then LSB) followed by one byte CRC checksum.

After power-up, the INT pin on SHT Click is set high by default, which can be cleared by sending a command to clear the status register.

|Sensor Command|Hex Code|
|:-----------------:|:---------:|
|Clear status register|0x3041|

Send the command below from the I3C Controller.

|Controller Operation|Data 1|Data 2|Data 3|Data 4|
|:-----------------:|:---------:|:---------:|:---------:|:------:|
|I2C Write|0x40|0x88|0x24|0x00|

<b>Interrupt from the SHT click (Alert Mode)</b>

The  INT pin of SHT click is set high when the sensor measurement crosses the threshold limit. The INT pin connected to the GPIO (RA1) of PIC8F16Q20 generates an interrupt. The PIC18F16Q20 sends an IBI to Controller informing that the threshold limit is crossed.

*Note*: The Alert mode is active only in Periodic Data Acquisition mode.

The below commands are used to configure the set limit and clear limit of upper threshold values. Similarly, the lower threshold limit could be configured.

|Sensor Command|Hex code|
|:-----------------:|:---------:|
|Set limit|0x611D|
|Clear limit|0x6116|

Refer to [How to use Alert Mode of SHT3x-DIS](https://sensirion.com/media/documents/40D749F7/616400BB/Sensirion_Humidity_Sensors_SHT3x_Application_Note_Alert_Mode_DIS.pdf) to understand how to calculate the threshold limit values.

Send the command below from the I3C Controller to configure the upper threshold limits.

|Threshold limit values <br>(Relative Humidity/Temperature)|Controller operation|Data 1|Data 2|Data 3|Data 4|Data 5|Data 6|Data 7|
|:--------:|:-----------------:|:---------:|:---------:|:---------:|:------:|:---------:|:---------:|:------:|
|80%/28<sup>o</sup>C|I2C Write|0x40|0x88|0x61|0x1D|0xCC|0xD5|0x6E
|79%/26<sup>o</sup>C|I2C Write|0x40|0x88|0x61|0x16|0xCA|0xCF|0xAC

<b>Measurement Command for Periodic Data Acquisition Mode</b>

|Sensor Command|Hex Code|
|:-----------------:|:---------:|
|Periodic data acquisition (At 2 mps)|0x2236|

Once the threshold limits are set, send the measurement command for data acquisition. In Periodic Data Acquisition mode, one issued measurement command yields a stream of data pairs. The measurement commands in this mode differs based on the  data acquisition frequency.

 Send the command below from the I3C Controller.

|Controller Operation|Data 1|Data 2|Data 3|Data 4|
|:-----------------:|:---------:|:---------:|:---------:|:------:|
|I2C Write|0x40|0x88|0x22|0x36|

<b>Readout of Measurement Results in Periodic Data Acquisition Mode</b>

|Sensor Command|Hex Code|
|:-----------------:|:---------:|
|Fetch Command|0xE000|

Transmission of the measurement data is initiated through the fetch data command. After the fetch command is sent from Controller, the result is read out by sending an I2C Read command for reading six bytes of data.

|Controller Operation|Data 1|Data 2|Data 3|Data 4|
|:-----------------:|:---------:|:---------:|:---------:|:---------:|
|I2C Write|0x40|0x88|0xE0|0x00|
|I2C Read|0x20|0x89|0x00|0x06|

### OLED B display

To initialize, OLED B display send the following command from I3C Controller. Refer to the [OLED B Data sheet](http://download.mikroe.com/documents/datasheets/MI9639BO-B_datasheet.pdf) for more details on the commands.

The CS pin in OLED B click is connected to SPI CS1 pin (RA4) of PIC18F16Q20 and D/C control pin is connected to SPI CS2 pin (RC7). When sending a data, D/C control pin is set high. When sending a command, D/C pin must be set low. The client ID bits in function ID must be set appropriately based on whether data send in a SPI write must be treated as data or command.

<div class="table-wrapper" markdown="block">

|Controller Operation|Data 1|Data 2|Data 3|Data 4|Data 5|Data 6|Data 7|Data 8|Data 9|Data 10|Data 11|Data 12|Data 13|Data 14|Data 15|Data 16|Data 17|Data 18|Data 19|Data 20|Data 21|Data 22|Data 23|Data 24|
|:-----------------:|:---------:|:---------:|:---------:|:---------:|:-----------------:|:---------:|:---------:|:---------:|:---------:|:-----------------:|:---------:|:---------:|:---------:|:---------:|:-----------------:|:---------:|:---------:|:---------:|:---------:|:-----------------:|:---------:|:---------:|:---------:|:-------:|
|SPI Write|0x43|0xAE|0xD5|0x80|0xA8|0x27|0xA1|0xC8|0xD3|0x0|0x8D|0x14|0x40|0xDA|0x12|0x81|0xAF|0xD9|0x25|0xDB|0x20|0xA4|0xA6|0xAF|

</div>

To send any characters (e.g.: send an "A") on the display, send the command in the format below.

|Controller Operation|Data 1|Data 2|Data 3|Data 4|
|:-----------------:|:---------:|:---------:|:---------:|:---------:|
|SPI Write|0x43|0xB0|0x12|0x00|
|SPI Write|0x41|0xF8|-|-|
|SPI Write|0x43|0xB0|0x12|0x01|
|SPI Write|0x41|0x24|-|-|
|SPI Write|0x43|0xB0|0x12|0x02|
|SPI Write|0x41|0x22|-|-|
|SPI Write|0x43|0xB0|0x12|0x03|
|SPI Write|0x41|0x24|-|-|
|SPI Write|0x43|0xB0|0x12|0x04|
|SPI Write|0x41|0xF8|-|-|
|SPI Write|0x43|0xB0|0x12|0x05|
|SPI Write|0x41|0x0|-|-|
|SPI Write|0x43|0xB0|0x12|0x03|
|SPI Write|0x41|0x24|-|-|

<b> Reset OLED C display </b>

Send the command below from the Controller to reset OLED B display.

|Controller Operation|Data 1|Data 2|
|:-----------------:|:---------:|:-------:|
|I2C Write|0x60|0x01|

Followed by it, send a Target Reset Pattern with RSTACT as 0x40 (OLED B display reset is performed when RESET action is defined at 0x40).

### On-board Debugger Virtual Serial Port

The virtual serial port of on-board debugger is used as the UART-based device to demonstrate communication between I3C Controller and UART channel. TX and RX pin of UART1 channel is internally connected to the on-board debugger CDC RX and CDC TX pins respectively.

To transmit five characters (e.g.: a-f) from the I3C Controller to the on-board debugger RX pin, send the command below with the ASCII value of the characters.

|Controller Operation|Data 1|Data 2|Data 3|Data 4|Data 5|Data 6|
|:-----------------:|:---------:|:-------:|:---------:|:-------:|:-------:|:-------:|
|UART Transmit|0x48|0x61|0x62|0x63|0x64|0x65|

For receiving any data from the on-board debugger TX pin to the I3C Controller, first send the value of stop byte command (e.g.: 0xA ie ASCII value of LF) from the I3C Controller. It can be only once or whenever user wants to modify the Stop Byte value.

|Controller Operation|Data 1|Data 2|
|:-----------------:|:---------:|:-------:|
|UART Recieve|0x28|0xA|

After receiving the data, it is checked against the value of the stop command and stored in an application buffer. When the data received is equal to the Stop byte value, the protocol translator sends the data received until now to the I3C Controller via IBI transaction.

#### Steps to observe data transaction on virtual serial port

To observe data transmitted or received on the virtual serial port in the Terminal window, the Curiosity Nano board needs to be connected to the terminal emulator. Data Visualizer can be used as a terminal emulator. Follow the procedure mentioned below to open the Terminal window in Data Visualizer.

Open the Data Visualizer tool which is available as a plugin in MPLAB X IDE.
1.	Open **COM7** Settings window. Set the Baud Rate to 9600.
**Note:** The COM port number can be different depending on the availability of the port.
2.	Click the right aligned triangle symbol on **COM7** tab to start capturing.

### Steps to observe debug messages

To see the debug messages of a multi-protocol translator in the Terminal window, connect the UART-USB click to a serial COM port on the PC.
Open any terminal emulator and set the baud rate of the respective serial COM port to 9600.

**Note**: If debug messages are being printed on terminal, make sure to keep  a delay between sending commands from Controller. For faster execution of code, comment the below macro in application.c to stop printing debug messages in terminal.

#define DEBUG_PRINT_ON

## Peripheral Configuration Using MCC
This section explains how to configure the peripherals using MPLAB X IDE with Melody Code Configurator (MCC) plugin to recreate this project.

Refer to the [Software Used](https://github.com/microchip-pic-avr-examples/pic16f17146-force-sensing-resistor-interface-mplab-mcc#software-used) section to install the required tools to recreate the project.

Additional Links: [MCC Melody Technical Reference](https://onlinedocs.microchip.com/v2/keyword-lookup?keyword=MCC.MELODY.INTRODUCTION&redirect=true)

### Peripheral Configuration Summary

| Peripherals               | Configuration                                                                                                                                                                                                                                                                                                                                                                                                  | Usage                                                                         |
|---------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
|    Clock Control    |    Clock source –   HFINTOSC<br>HF Internal Clock – 64 MHz<br>Clock Divider   – 1                                                                                                                                                                                                                                                                                                         |    System  clock                                                                     |
|    I3C2_Target_DMA | *I3C2_Target_DMA Driver* <br><br> Tx DMA Channel Selection - DMA1 <br>Rx DMA Channel Selection - DMA2 <br>I3C PLIB Selector - I3C2<br><br>Transaction settings<br>Hot-Join Capable - Enable<br> Default Private Transaction Acknowledge - Not acknowledge <br><br> *I3C2PLIB* <br><br> Enable Module<br>Clock source Fosc<br>Input Buffer (SDA and SCL Pins) - I3C Low Voltage(LV) Buffer <br> <br>System Level Interrupt Settings<br>Enable General Interrupt and Reset Interrupt <br><br>*Note: All the other configurations are retained with default selections.*| Used as I3C Target|
|    SPI1_Host               |    *SPI1_Host Driver*<br><br>User Configurations:<br>Config Name: HOST_CONFIG<br>Requested Speed: 2000 kHz <br>Mode: Mode 0<br>Data Input Sampled At: Middle<br>Clock Source Selection - Fosc<br> <br>*SPI1 PLIB*<br><br> Config Name: HOST_CONFIG, Clock Source: FOSC, Clock Frequency (Hz): 64000000              |    Used as SPI Host                                        |                             |
|    I2C1_Host              |  *I2C1_Host Driver* <br><br>Requested Speed - 100 KHz<br><br>*I2C1_Peripheral* <br><br>Clock Source Selection - Fosc<br>Fast Mode - Standard Mode<br>Enable Interrupt Driven   |   Used as I2C host<br>   <br> |                                                              
|    UART1                | *UART1 Driver* <br><br>Custom Name - UART_PROTOCOL_PORT<br> Requested Baudrate – 9600 <br> <br>Interrupt Settings: <br>Enable Interrupt Driven<br>Software Transmit Buffer Size - 8 <br> Software Receive Buffer Size - 8 <br><br>UART PLIB Selector – UART1<br>      <br>*UART1 PLIB*<br>   <br>Enable Transmit<br> Enable Receive<br> Enable UART<br><br>Interrupt Settings: <br>Enable Receive Interrupt<br>Enable Transmit Interrupt<br>|    Used for Transmit and Receive data from UART devices   |
|    UART2                | *UART2 Driver* <br><br>Custom Name - DEBUG_PORT<br> Requested Baudrate – 9600 <br>Enable Redirect Printf to UART<br>UART PLIB Selector – UART2<br>      <br>*UART2 PLIB*<br>   <br>Enable Transmit<br> Enable UART<br>|   Send data to terminal   |
|	 Pin Settings		  |    *Pin Grid View* <br>I3C2<br>I3C2SCL : RB6 <br>I3C2SDA : RB5<br><br>I2C1<br>SCL1 : RC0 <br>SDA1 : RC1<br><br>SPI1<br>SCK1 : RA5 <br>SDI1 : RC6<br>SDO1 : RC3<br><br>UART1<br>TX1 : RC4<br>RX1 : RC5<br>TX2 : RA1<br><br>GPIO<br> Output : RA0, RA4, RB7, RC7 <br> Input : RA2<br> <br> *Pins* <br>RA2<br>Custom Name : INT_pin1 <br>Interrupt on Change - positive<br><br>RA0<br>Custom Name : RST_pin1<br>Start High <br><br>RA4<br>Custom Name : CS1 <br>Start High<br><br>RC7<br>Custom Name : CS2 <br>Start High<br><br>RB7<br>Custom Name : CS3 <br>Start High <br>																																														|    Pin Configurations																	|
| Configuration Bits        | CONFIG7 <br>VDDIO3 supply mode bit -Low-voltage Operating Range (VDDIO3 < 1.62V) <br> Update this to standard operating range if VDDIO3 > 1.62 V<br>| Configuration Register|

## Summary
A multi-protocol translator is implemented using PIC18F16Q20 I3C Target module which converts I3C to I2C, I3C to SPI and I3C to UART protocol.
